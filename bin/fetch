#!/bin/bash

set -e

function _warn {
    echo "$*" 1>/dev/stderr
}

function _die {
    _warn "$*"
    exit 64
}

function _have {
    type -P "" &>/dev/null
}

function _pushmd {
	if [[ -z $1 ]] 
	then
		_warn "_pushmd: Missing directory name"
        return 64
	fi

	mkdir -p $1 || return 64
	pushd $1 || return 64
}

function _fetch {
    echo "> Fetch $*"
    curl -OL $*
}

_pushmd "source"

_pushmd "yzzy"
    _fetch "https://github.com/robertkrimen/yzzy-js/raw/master/yzzy.js"
    _fetch "https://github.com/robertkrimen/DOMite-js/raw/master/DOMite.js"
    _fetch "https://github.com/robertkrimen/nvc-js/raw/master/nvc.js"
popd

_fetch "https://github.com/documentcloud/underscore/raw/1.1.5/underscore.js"
_fetch "https://github.com/documentcloud/underscore/raw/1.1.5/underscore-min.js"

_pushmd "tipsy"
    _fetch "https://github.com/jaz303/tipsy/raw/master/src/images/tipsy.gif"
    _fetch "https://github.com/jaz303/tipsy/raw/master/src/javascripts/jquery.tipsy.js"
    _fetch "https://github.com/jaz303/tipsy/raw/master/src/stylesheets/tipsy.css"
    perl -pi -e "s{url\('../images/}{url\('}g" tipsy.css
popd


_pushmd "css3buttons"
    _fetch -L https://github.com/michenriksen/css3buttons/raw/master/stylesheets/css3buttons.css 
    perl -pi -e "s{url\('../images/css3buttons_backgrounds.png'\)}{url\(css3buttons-background.png\)}g" css3buttons.css
    perl -pi -e "s{url\('../images/css3buttons_icons.png'\)}{url\(css3buttons-icon.png\)}g" css3buttons.css
    curl -L https://github.com/michenriksen/css3buttons/raw/master/images/css3buttons_backgrounds.png -o css3buttons-background.png
    curl -L https://github.com/michenriksen/css3buttons/raw/master/images/css3buttons_icons.png -o css3buttons-icon.png
popd

for extension in {,.min}.js
do
    _fetch https://ajax.googleapis.com/ajax/libs/jquery/1/jquery$extension
    _fetch https://ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui$extension
    _fetch https://github.com/jquery/jquery-tmpl/raw/master/jquery.tmpl$extension
done

_fetch -OL https://github.com/douglascrockford/JSON-js/raw/master/json2.js

_pushmd "960"
    for file in {960,reset,text}.css
    do
        _pushmd "uncompressed"
        _fetch https://github.com/nathansmith/960-Grid-System/raw/master/code/css/$file
        popd || exit 64
        _fetch https://github.com/nathansmith/960-Grid-System/raw/master/code/css/min/$file
    done
popd

_pushmd "qunit"
    _fetch "https://github.com/jquery/qunit/raw/master/qunit/qunit.css"
    _fetch "https://github.com/jquery/qunit/raw/master/qunit/qunit.js"
popd

_pushmd "jquery-ui"
    for theme in base ui-lightness
    do
        _pushmd $theme
        _fetch http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/$theme/jquery-ui.css 

        _pushmd "jquery-ui"
        for url in `<../jquery-ui.css perl -ne 'm/url\(([^)]+)\)/ and print "$1\n"'`
        do
            _fetch http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/$theme/$url
        done
        popd

        perl -pi -e 's/url\(images/url\(jquery-ui/g' jquery-ui.css
        popd
    done
popd

